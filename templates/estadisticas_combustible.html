{% extends "base.html" %}


{% block title %}Gráficas y Estadísticas{% endblock %}
{% block content %}

            <div class="d-sm-flex align-items-center justify-content-between mb-4">
                <h1 class="h3 mb-0 text-gray-800">Gráficas y Estadísticas</h1>
            </div>

            <div class="row">
                <!-- Filtros para Ventas de Combustible -->
                <div class="col-lg-6 mb-4">
                    <div class="card shadow">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary">Filtros de Ventas por Combustible</h6>
                        </div>
                        <div class="card-body">
                            <form method="GET" action="{{ url_for('estadisticas_combustible') }}">
                                {# Mantener filtros de productos más vendidos activos #}
                                <input type="hidden" name="cliente_producto" value="{{ request.args.get('cliente_producto', '') }}">
                                <input type="hidden" name="mes_producto" value="{{ request.args.get('mes_producto', '') }}">
                                <input type="hidden" name="anio_producto" value="{{ request.args.get('anio_producto', '') }}">
                                <div class="row">
                                    <div class="col-md-4">
                                        <label for="cliente_combustible" class="form-label">Cliente</label>
                                        <select name="cliente_combustible" id="cliente_combustible" class="form-select">
                                            <option value="">Todos los clientes</option>
                                            {% for cliente in clientes %}
                                                <option value="{{ cliente.ClienteID }}" {% if cliente.ClienteID|string == request.args.get('cliente_combustible') %}selected{% endif %}>{{ cliente.Nombre }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="mes_combustible" class="form-label">Mes</label>
                                        <select name="mes_combustible" id="mes_combustible" class="form-select">
                                            <option value="">Todos</option>
                                            {% for i in range(1, 13) %}
                                                <option value="{{ i }}" {% if i|string == request.args.get('mes_combustible') %}selected{% endif %}>{{ i }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="anio_combustible" class="form-label">Año</label>
                                        <select name="anio_combustible" id="anio_combustible" class="form-select">
                                            <option value="">Todos</option>
                                            {% for anio in anios_ventas %}
                                                <option value="{{ anio }}" {% if anio|string == request.args.get('anio_combustible') %}selected{% endif %}>{{ anio }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <button type="submit" class="btn btn-primary"><i class="bi bi-funnel-fill me-2"></i>Filtrar</button>
                                    <a href="{{ url_for('estadisticas_combustible', cliente_combustible='', mes_combustible='', anio_combustible='', cliente_producto=request.args.get('cliente_producto',''), mes_producto=request.args.get('mes_producto',''), anio_producto=request.args.get('anio_producto','')) }}" class="btn btn-outline-secondary"><i class="bi bi-x-circle me-2"></i>Quitar Filtros</a>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Filtros para Productos más Vendidos -->
                <div class="col-lg-6 mb-4">
                    <div class="card shadow">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-success">Filtros de Productos Más Vendidos</h6>
                        </div>
                        <div class="card-body">
                            <form method="GET" action="{{ url_for('estadisticas_combustible') }}">
                                {# Mantener filtros de ventas de combustible activos #}
                                <input type="hidden" name="cliente_combustible" value="{{ request.args.get('cliente_combustible', '') }}">
                                <input type="hidden" name="mes_combustible" value="{{ request.args.get('mes_combustible', '') }}">
                                <input type="hidden" name="anio_combustible" value="{{ request.args.get('anio_combustible', '') }}">
                                <div class="row">
                                    <div class="col-md-4">
                                        <label for="cliente_producto" class="form-label">Cliente</label>
                                        <select name="cliente_producto" id="cliente_producto" class="form-select">
                                            <option value="">Todos los clientes</option>
                                            {% for cliente in clientes %}
                                                <option value="{{ cliente.ClienteID }}" {% if cliente.ClienteID|string == request.args.get('cliente_producto') %}selected{% endif %}>{{ cliente.Nombre }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="mes_producto" class="form-label">Mes</label>
                                        <select name="mes_producto" id="mes_producto" class="form-select">
                                            <option value="">Todos</option>
                                            {% for i in range(1, 13) %}
                                                <option value="{{ i }}" {% if i|string == request.args.get('mes_producto') %}selected{% endif %}>{{ i }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="anio_producto" class="form-label">Año</label>
                                        <select name="anio_producto" id="anio_producto" class="form-select">
                                            <option value="">Todos</option>
                                            {% for anio in anios_productos %}
                                                <option value="{{ anio }}" {% if anio|string == request.args.get('anio_producto') %}selected{% endif %}>{{ anio }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <button type="submit" class="btn btn-success"><i class="bi bi-funnel-fill me-2"></i>Filtrar</button>
                                    <a href="{{ url_for('estadisticas_productos', cliente_producto='', mes_producto='', anio_producto='', cliente_combustible=request.args.get('cliente_combustible',''), mes_combustible=request.args.get('mes_combustible',''), anio_combustible=request.args.get('anio_combustible','')) }}" class="btn btn-outline-secondary"><i class="bi bi-x-circle me-2"></i>Quitar Filtros</a>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <!-- Gráfica de Ventas Mensuales -->
                <div class="col-lg-6">
                    <div class="card shadow mb-4">
                        <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between" style="background-color: #1e40af; color: white;">
                            <h6 class="m-0 font-weight-bold">Ventas Mensuales por Combustible</h6>
                        </div>
                        <div class="card-body">
                            <div class="chart-area" style="height: 320px;">
                                <canvas id="ventasMensualesChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gráfica de Productos más Vendidos -->
                <div class="col-lg-6">
                    <div class="card shadow mb-4">
                        <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between" style="background-color: #16a34a; color: white;">
                            <h6 class="m-0 font-weight-bold">Productos Más Vendidos</h6>
                        </div>
                        <div class="card-body">
                            <div class="chart-pie pt-4" style="height: 320px;">
                                <canvas id="productosMasVendidosChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    <!-- Bloques JSON seguros para JS -->
    <script id="ventas-json" type="application/json">{{ ventas_mensuales_combustible | tojson }}</script>
    <script id="productos-json" type="application/json">{{ productos_mas_vendidos | tojson }}</script>
{% endblock %}

{% block scripts %}
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script>
        // Función para mostrar mensajes de error en los canvas
        function mostrarMensajeError(canvas, mensaje) {
            if (!canvas) return;
    
            const ctx = canvas.getContext('2d');
            if (!ctx) return;
    
            // Limpiar el canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
    
            // Configurar el estilo del texto
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.font = '16px "Nunito", sans-serif';
            ctx.fillStyle = '#6c757d';
    
            // Dividir el mensaje en líneas si es muy largo
            const maxAncho = canvas.width * 0.9; // 90% del ancho del canvas
            const lineas = [];
            let lineaActual = '';
            const palabras = mensaje.split(' ');
    
            palabras.forEach(palabra => {
                const texto = lineaActual ? `${lineaActual} ${palabra}` : palabra;
                const ancho = ctx.measureText(texto).width;
        
                if (ancho < maxAncho) {
                    lineaActual = texto;
                } else {
                    lineas.push(lineaActual);
                    lineaActual = palabra;
                }
            });
    
            if (lineaActual) {
                lineas.push(lineaActual);
            }
    
            // Dibujar cada línea centrada
            const alturaLinea = 24;
            const inicioY = (canvas.height - (lineas.length * alturaLinea)) / 2;
    
            lineas.forEach((linea, index) => {
                ctx.fillText(linea, canvas.width / 2, inicioY + (index * alturaLinea));
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar tooltips de Bootstrap
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
            // -----------------------------------------------------------------
            // GRÁFICA DE VENTAS MENSUALES DE COMBUSTIBLE (BARRAS VERTICALES AGRUPADAS POR TIPO)
            // -----------------------------------------------------------------
            const ctxVentas = document.getElementById('ventasMensualesChart');
            const ventasData = JSON.parse(document.getElementById('ventas-json').textContent);
            console.log('Datos de ventas recibidos:', ventasData);

            if (ctxVentas && ventasData && ventasData.length > 0) {
                const monthNames = ["", "Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"];
                try {
                    // 1. Obtener meses únicos y ordenados para las etiquetas del eje X
                    const labels = [...new Set(ventasData.map(item => parseInt(item[0])))].sort((a, b) => a - b);
                    const monthLabels = labels.map(m => monthNames[m] || m);

                    // 2. Obtener los tipos de combustible únicos para crear los datasets
                    const tiposCombustible = [...new Set(ventasData.map(item => String(item[1])))].filter(Boolean);

                    // Paleta de colores para los tipos de combustible
                    const backgroundColors = [
                        'rgba(30, 64, 175, 0.8)',  // Azul oscuro
                        'rgba(16, 185, 129, 0.8)', // Verde
                        'rgba(245, 158, 11, 0.8)', // Amarillo
                        'rgba(239, 68, 68, 0.8)',  // Rojo
                        'rgba(139, 92, 246, 0.8)', // Violeta
                        'rgba(20, 184, 166, 0.8)'  // Verde azulado
                    ];
                    const borderColors = backgroundColors.map(color => color.replace('0.8', '1'));

                    // 3. Crear un dataset por cada tipo de combustible (no apilado, sino agrupado)
                    const datasets = tiposCombustible.map((tipo, index) => {
                        const data = labels.map(month => {
                            // Buscar la venta para el mes y tipo de combustible actual
                            const entry = ventasData.find(item => 
                                parseInt(item[0]) === month && String(item[1]) === tipo
                            );
                            return entry ? parseFloat(entry[2]) || 0 : 0;
                        });
                        return {
                            label: tipo,
                            data: data,
                            backgroundColor: backgroundColors[index % backgroundColors.length],
                            borderColor: borderColors[index % borderColors.length],
                            borderWidth: 1,
                            borderRadius: 4,
                            barPercentage: 0.8,
                            categoryPercentage: 0.9
                        };
                    });

                    new Chart(ctxVentas, {
                        type: 'bar',
                        data: {
                            labels: monthLabels,
                            datasets: datasets
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: { 
                                    beginAtZero: true, 
                                    title: { 
                                        display: true, 
                                        text: 'Litros Vendidos',
                                        font: {
                                            weight: 'bold'
                                        }
                                    },
                                    ticks: {
                                        callback: function(value) {
                                            return new Intl.NumberFormat('es-GT').format(value);
                                        }
                                    }
                                },
                                x: { 
                                    title: {
                                        display: true,
                                        text: 'Mes',
                                        font: {
                                            weight: 'bold'
                                        }
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    position: 'top',
                                    labels: {
                                        boxWidth: 12,
                                        padding: 20
                                    }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            let label = context.dataset.label || '';
                                            if (label) {
                                                label += ': ';
                                            }
                                            if (context.parsed.y !== null) {
                                                label += new Intl.NumberFormat('es-GT', { 
                                                    minimumFractionDigits: 2,
                                                    maximumFractionDigits: 2 
                                                }).format(context.parsed.y) + ' L';
                                            }
                                            return label;
                                        }
                                    }
                                }
                            },
                            animation: {
                                duration: 1500,
                                easing: 'easeInOutQuart'
                            }
                        }
                    });
                } catch (error) {
                    console.error('Error al procesar los datos de ventas:', error);
                    mostrarMensajeError(ctxVentas, 'Error al cargar los datos de ventas');
                }
            } else if (ctxVentas) {
                mostrarMensajeError(ctxVentas, 'No hay datos de ventas de combustible para mostrar.');
            }

            // -----------------------------------------------------------------
            // GRÁFICA DE PRODUCTOS MÁS VENDIDOS (GRÁFICO DE BARRAS HORIZONTAL)
            // -----------------------------------------------------------------
            const ctxProductos = document.getElementById('productosMasVendidosChart');
            const productosData = JSON.parse(document.getElementById('productos-json').textContent);
            console.log('Datos de productos recibidos:', productosData);

            if (ctxProductos && productosData && productosData.length > 0) {
                try {
                    // Limitar a los 10 productos más vendidos para mejor visualización
                    const productosLimitados = productosData.slice(0, 10);
                    const labelsProductos = productosLimitados.map(item => String(item[0] || 'Sin nombre'));
                    const dataProductos = productosLimitados.map(item => parseInt(item[1]) || 0);
                    const backgroundColors = [
                        '#fbbf24', '#818cf8', '#f472b6', '#34d399', '#60a5fa',
                        '#f87171', '#a3e635', '#facc15', '#38bdf8', '#f472b6'
                    ];

                    new Chart(ctxProductos, {
                        type: 'bar',
                        data: {
                            labels: labelsProductos,
                            datasets: [{
                                label: 'Cantidad Vendida',
                                data: dataProductos,
                                backgroundColor: backgroundColors.slice(0, dataProductos.length),
                                borderWidth: 1,
                                borderRadius: 4,
                                maxBarThickness: 28
                            }]
                        },
                        options: {
                            indexAxis: 'y',
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                },
                                title: {
                                    display: true,
                                    text: 'Productos Más Vendidos',
                                    font: {
                                        size: 18,
                                        weight: 'bold'
                                    },
                                    padding: {
                                        bottom: 10
                                    }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return `${context.label}: ${context.parsed.x} unidades`;
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'Cantidad Vendida',
                                        font: { weight: 'bold' }
                                    }
                                },
                                y: {
                                    title: {
                                        display: false
                                    }
                                }
                            }
                        }
                    });
                } catch (error) {
                    console.error('Error al procesar los datos de productos:', error);
                    mostrarMensajeError(ctxProductos, 'Error al cargar los datos de productos');
                }
            } else if (ctxProductos) {
                mostrarMensajeError(ctxProductos, 'No hay datos de productos vendidos para mostrar.');
            }
        });
    </script>
{% endblock %}