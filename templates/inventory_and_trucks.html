{% extends 'base.html' %}
{% block title %}Inventario de Combustible y Registro de Pipas{% endblock %}
{% block content %}
<div class="mb-3">
  <h5 class="fw-bold text-success">Saldos Actuales por Tipo de Combustible</h5>
  <div class="table-responsive">
    <table class="table table-bordered table-sm mb-0">
      <thead class="table-light">
        <tr>
          <th>Tipo</th>
          <th>Saldo Actual</th>
        </tr>
      </thead>
      <tbody>
        {% for tipo, saldo in saldos_actuales.items() %}
        <tr>
          <td>{{ tipo }}</td>
          <td>{{ "{:,.2f}".format(saldo) }} L</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
<div class="card shadow-sm mb-4">
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="mb-0 text-primary fw-bold">Inventario de Combustible</h4>
            <a href="#" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#nuevoRegistroModal"><i class="bi bi-plus-lg"></i> Nuevo Registro</a>
        </div>
        <!-- Filtro de mes y año -->
        <form method="get" class="mb-3">
          <label>Mes:</label>
          <select name="mes">
            {% for m in range(1, 13) %}
              <option value="{{ m }}" {% if m == mes %}selected{% endif %}>{{ m }}</option>
            {% endfor %}
          </select>
          <label>Año:</label>
          <input type="number" name="anio" value="{{ anio }}" min="2000" max="2100">
          <button type="submit" class="btn btn-primary btn-sm">Filtrar</button>
        </form>
        <div class="table-responsive">
            <table class="table table-bordered align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th>ID</th>
                        <th>Tipo</th>
                        <th>Inventario Inicial</th>
                        <th>Entrada</th>
                        <th>Salida</th>
                        <th>Inventario Final</th>
                        <th>Fecha</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                  {% for registro in registros %}
                  <tr data-fecha="{{ registro.Fecha.strftime('%Y-%m-%d') if registro.Fecha else '' }}">
                    <td>{{ registro.InventarioID }}</td>
                    <td>{{ registro.NombreTipo }}</td>
                    <td>{{ "{:,.2f}".format(registro.InventarioInicial | float) }} L</td>
                    <td>{{ "{:,.2f}".format(registro.Entrada | float) }} L</td>
                    <td>{{ "{:,.2f}".format(registro.Salida | float) }} L</td>
                    <td>{{ "{:,.2f}".format(registro.InventarioFinal | float) }} L</td>
                    <td>
                      {% if registro.Fecha %}
                        {{ registro.Fecha.strftime('%d-%m-%Y') }}
                      {% endif %}
                    </td>
                    <td>
                      {% if registro.EsAutomatico != 1 and registro.EsAutomatico != '1' %}
                        <a href="#" class="text-primary me-2 btn-editar" data-bs-toggle="modal" data-bs-target="#editarModal{{ registro.InventarioID }}"><i class="bi bi-pencil-square"></i></a>
                        {% if session.get('rol') == 'admin' %}
                          <a href="#" class="text-danger me-2 btn-eliminar" data-bs-toggle="modal" data-bs-target="#eliminarModal{{ registro.InventarioID }}"><i class="bi bi-trash"></i></a>
                        {% endif %}
                      {% endif %}
                    </td>
                  </tr>
                  {% else %}
                  <tr>
                      <td colspan="9" class="text-center text-muted">No hay registros de inventario.</td>
                  </tr>
                  {% endfor %}
                </tbody>
            </table>   
        </div>
         <!-- Paginación -->
         <nav class="mt-3">
          <ul class="pagination">
            <li class="page-item {% if page == 1 %}disabled{% endif %}">
              <a class="page-link" href="?page={{ page-1 }}&mes={{ mes }}&anio={{ anio }}">Anterior</a>
            </li>
            {% for p in range(1, (total // per_page) + (1 if total % per_page else 0) + 1) %}
              <li class="page-item {% if p == page %}active{% endif %}">
                <a class="page-link" href="?page={{ p }}&mes={{ mes }}&anio={{ anio }}">{{ p }}</a>
              </li>
            {% endfor %}
            <li class="page-item {% if page >= (total // per_page) + (1 if total % per_page else 0) %}disabled{% endif %}">
              <a class="page-link" href="?page={{ page+1 }}&mes={{ mes }}&anio={{ anio }}">Siguiente</a>
            </li>
          </ul>
        </nav>
    </div>
</div>

<!-- Reemplaza desde aquí la sección de pipas -->
<div class="card shadow-sm mb-4">
  <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-3">
          <h4 class="mb-0 text-primary fw-bold">Registro de Pipas</h4>
          <a href="#" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#nuevaPipaModal">
              <i class="bi bi-plus-lg"></i> Nueva Pipa
          </a>
      </div>
    <div class="row" id="contenedor-pipas">
      {% include '_pipas_list.html' %}
    </div>
  </div>
</div>

<!-- Modal para nueva pipa -->
<div class="modal fade" id="nuevaPipaModal" tabindex="-1" aria-labelledby="nuevaPipaModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form id="form-nueva-pipa" method="post" action="{{ url_for('inventory_and_trucks') }}">
      <input type="hidden" name="form_type" value="pipa">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="nuevaPipaModalLabel">Nueva Pipa</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
            <div class="mb-2">
              <label>Placa</label>
              <input type="text" name="placa" class="form-control" required>
            </div>
            <div class="mb-2">
              <label>Capacidad (L)</label>
              <input type="number" step="0.01" name="capacidad" class="form-control" required>
            </div>
            <div class="mb-2">
              <label>Tipo de Combustible</label>
              <select name="tipo_combustible_id" class="form-control" required>
                {% for tipo in tipos_combustible %}
                  <option value="{{ tipo.id }}">{{ tipo.nombre }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="mb-2">
              <label>Conductor Asignado</label>
              <input type="text" name="conductor_asignado" class="form-control">
            </div>
            <div class="mb-2">
              <label>Estado</label>
              <select name="estado" class="form-control" required>
                <option value="Activa">Activa</option>
                <option value="En mantenimiento">En mantenimiento</option>
              </select>
            </div>
            <div class="mb-2">
              <label>Ubicación Actual</label>
              <input type="text" name="ubicacion_actual" class="form-control">
            </div>
            <div class="mb-2">
              <label>Último Mantenimiento</label>
              <input type="date" name="ultimo_mantenimiento" class="form-control">
            </div>
            <div class="mb-2">
              <label>Próximo Mantenimiento</label>
              <input type="date" name="proximo_mantenimiento" class="form-control">
            </div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-primary">Guardar</button>
          </div>
        </div>
      </form>
    </div>
</div>

<!-- Modal para nuevo registro de inventario -->
<div class="modal fade" id="nuevoRegistroModal" tabindex="-1" aria-labelledby="nuevoRegistroModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form method="post" action="{{ url_for('inventory_and_trucks') }}">
      <input type="hidden" name="form_type" value="inventario">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="nuevoRegistroModalLabel">Nuevo Registro de Inventario</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <div class="mb-2">
            <label>Tipo</label>
            <select name="tipo" class="form-control" id="tipo-combustible" required>
              {% for tipo in tipos_combustible %}
                <option value="{{ tipo.id }}" {% if tipo.id == tipo_default_id %}selected{% endif %}>{{ tipo.nombre }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-2">
            <label>Inventario Inicial</label>
            <input type="text" name="inventario_inicial" class="form-control" id="inventario-inicial" required readonly>
          </div>
          <div class="mb-2">
            <label>Entrada</label>
            <input type="number" name="entrada" class="form-control" id="entrada" value="0" required>
          </div>
          <div class="mb-2">
            <label>Salida</label>
            <input type="number" name="salida" class="form-control" id="salida" value="0" required>
          </div>
          <div class="mb-2">
            <label>Inventario Final</label>
            <input type="text" name="inventario_final" class="form-control" id="inventario-final" readonly>
          </div>
          <div class="mb-2">
            <label>Fecha</label>
            <input type="date" name="fecha" class="form-control" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Guardar</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Modales de edición y eliminación para cada pipa -->
{% for pipa in pipas %}
<!-- Modal Editar Pipa -->
<div class="modal fade" id="editarPipaModal{{ pipa.id }}" tabindex="-1" aria-labelledby="editarPipaModalLabel{{ pipa.id }}" aria-hidden="true">
  <div class="modal-dialog">
    <form method="post" action="{{ url_for('editar_pipa', id=pipa.id) }}">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editarPipaModalLabel{{ pipa.id }}">Editar Pipa</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <div class="mb-2">
            <label>Placa</label>
            <input type="text" name="placa" class="form-control" value="{{ pipa.placa }}" required>
          </div>
          <div class="mb-2">
            <label>Capacidad (L)</label>
            <input type="number" step="0.01" name="capacidad" class="form-control" value="{{ pipa.capacidad }}" required>
          </div>
          <div class="mb-2">
            <label>Tipo de Combustible</label>
            <select name="tipo_combustible_id" class="form-control" required>
              {% for tipo in tipos_combustible %}
                <option value="{{ tipo.id }}">{{ tipo.nombre }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-2">
            <label>Conductor Asignado</label>
            <input type="text" name="conductor_asignado" class="form-control" value="{{ pipa.conductor_asignado }}">
          </div>
          <div class="mb-2">
            <label>Estado</label>
            <select name="estado" class="form-control" required>
              <option value="Activa" {% if pipa.estado == 'Activa' %}selected{% endif %}>Activa</option>
              <option value="En mantenimiento" {% if pipa.estado == 'En mantenimiento' %}selected{% endif %}>En mantenimiento</option>
            </select>
          </div>
          <div class="mb-2">
            <label>Ubicación Actual</label>
            <input type="text" name="ubicacion_actual" class="form-control" value="{{ pipa.ubicacion_actual }}">
          </div>
          <div class="mb-2">
            <label>Último Mantenimiento</label>
            <input type="date" name="ultimo_mantenimiento" class="form-control" value="{{ pipa.ultimo_mantenimiento }}">
          </div>
          <div class="mb-2">
            <label>Próximo Mantenimiento</label>
            <input type="date" name="proximo_mantenimiento" class="form-control" value="{{ pipa.proximo_mantenimiento }}">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Guardar Cambios</button>
        </div>
      </div>
    </form>
  </div>
</div>
<!-- Modal Eliminar Pipa -->
<div class="modal fade" id="eliminarPipaModal{{ pipa.id }}" tabindex="-1" aria-labelledby="eliminarPipaModalLabel{{ pipa.id }}" aria-hidden="true">
  <div class="modal-dialog">
    <form method="post" action="{{ url_for('eliminar_pipa', id=pipa.id) }}">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="eliminarPipaModalLabel{{ pipa.id }}">Eliminar Pipa</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          ¿Estás seguro de que deseas eliminar esta pipa?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-danger">Eliminar</button>
        </div>
      </div>
    </form>
  </div>
</div>
{% endfor %}

<!-- Modales de edición y eliminación -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Para todos los modales de edición de inventario
    document.querySelectorAll('[id^="editarModal"]').forEach(function(modal) {
      const inventarioInicialInput = modal.querySelector('input[name="inventario_inicial"]');
      const entradaInput = modal.querySelector('input[name="entrada"]');
      const salidaInput = modal.querySelector('input[name="salida"]');
      const inventarioFinalInput = modal.querySelector('input[name="inventario_final"]');
      if (entradaInput && salidaInput && inventarioInicialInput && inventarioFinalInput) {
        function alternarBloqueoCampos() {
          // Si Entrada tiene valor, bloquear Salida
          if (entradaInput.value && parseFloat(entradaInput.value) > 0) {
            salidaInput.value = '';
            salidaInput.disabled = true;
          } else {
            salidaInput.disabled = false;
          }
          // Si Salida tiene valor, bloquear Entrada
          if (salidaInput.value && parseFloat(salidaInput.value) > 0) {
            entradaInput.value = '';
            entradaInput.disabled = true;
          } else {
            entradaInput.disabled = false;
          }
        }

        // Restaurar valores originales al abrir el modal
        modal.addEventListener('show.bs.modal', function() {
          inventarioInicialInput.value = inventarioInicialInput.getAttribute('data-original');
          entradaInput.value = entradaInput.getAttribute('data-original');
          salidaInput.value = salidaInput.getAttribute('data-original');
          inventarioFinalInput.value = inventarioFinalInput.getAttribute('data-original');
          calcularInventarioFinalEdicion();
        });
        function calcularInventarioFinalEdicion() {
          // Forzar conversión numérica robusta para evitar concatenación de strings
          const inicial = parseFloat((inventarioInicialInput.value || '0').replace(/,/g, '')) || 0;
          let entradaRaw = (entradaInput.value || '').replace(/,/g, '').trim();
          let salidaRaw = (salidaInput.value || '').replace(/,/g, '').trim();
          let entradaCalc = parseFloat(entradaRaw);
          let salidaCalc = parseFloat(salidaRaw);
          if (isNaN(entradaCalc)) entradaCalc = 0;
          if (isNaN(salidaCalc)) salidaCalc = 0;
          // Si los valores son demasiado grandes para JS, limitar a Number.MAX_SAFE_INTEGER
          if (entradaCalc > Number.MAX_SAFE_INTEGER) entradaCalc = Number.MAX_SAFE_INTEGER;
          if (salidaCalc > Number.MAX_SAFE_INTEGER) salidaCalc = Number.MAX_SAFE_INTEGER;
          const final = inicial + entradaCalc - salidaCalc;
          inventarioFinalInput.value = final.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        }
        entradaInput.addEventListener('input', calcularInventarioFinalEdicion);
        salidaInput.addEventListener('input', calcularInventarioFinalEdicion);
        // Bloqueo dinámico de campos
        entradaInput.addEventListener('input', alternarBloqueoCampos);
        salidaInput.addEventListener('input', alternarBloqueoCampos);
        modal.addEventListener('shown.bs.modal', function() {
          calcularInventarioFinalEdicion();
          alternarBloqueoCampos();
        });
      }
    });
  });
</script>
{% for registro in registros %}
<!-- Modal para editar registro de inventario -->
<div class="modal fade" id="editarModal{{ registro.InventarioID }}" tabindex="-1" aria-labelledby="editarModalLabel{{ registro.InventarioID }}" aria-hidden="true">
  <div class="modal-dialog">
      <form method="post" action="{{ url_for('editar_registro', id=registro.InventarioID) }}">
          <div class="modal-content">
              <div class="modal-header">
                  <h5 class="modal-title" id="editarModalLabel{{ registro.InventarioID }}">Editar Registro</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                  <input type="text" name="inventario_id" class="form-control" value="{{ registro.InventarioID }}" readonly>
                  <div class="mb-2">
                    <label>Tipo</label>
                    <input type="text" class="form-control" value="{{ registro.NombreTipo }}" readonly>
                    <input type="hidden" name="tipo" value="{{ registro.TipoCombustibleID }}">
                  </div>
                  <div class="mb-2">
                      <label>Inventario Inicial</label>
                      <input type="text" name="inventario_inicial" class="form-control" value="{{ "{:,.2f}".format(registro.InventarioInicial|float) }}" readonly data-original="{{ "{:,.2f}".format(registro.InventarioInicial|float) }}">
                  </div>
                  <div class="mb-2">
                      <label>Entrada</label>
                      <input type="number" name="entrada" class="form-control" value="{{ registro.Entrada|float if registro.Entrada|float != 0 else '' }}" data-original="{{ registro.Entrada|float if registro.Entrada|float != 0 else '' }}">
                  </div>
                  <div class="mb-2">
                      <label>Salida</label>
                      <input type="number" name="salida" class="form-control" value="{{ registro.Salida|float if registro.Salida|float != 0 else '' }}" data-original="{{ registro.Salida|float if registro.Salida|float != 0 else '' }}">
                  </div>
                  <div class="mb-2">
                      <label>Inventario Final</label>
                      <input type="text" name="inventario_final" class="form-control" value="{{ "{:,.2f}".format(registro.InventarioFinal|float) }}" readonly data-original="{{ "{:,.2f}".format(registro.InventarioFinal|float) }}">
                  </div>
                  <div class="mb-2">
                      <label>Fecha</label>
                      <input type="date" name="fecha" class="form-control" value="{{ registro.Fecha|replace('/', '-') }}" readonly>
                  </div>
              </div>
              <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                  <button type="submit" class="btn btn-primary">Guardar Cambios</button>
              </div>
          </div>
      </form>
  </div>
</div>

<!-- Modal para eliminar registro de inventario -->
<div class="modal fade" id="eliminarModal{{ registro.InventarioID }}" tabindex="-1" aria-labelledby="eliminarModalLabel{{ registro.InventarioID }}" aria-hidden="true">
    <div class="modal-dialog">
        <form method="post" action="{{ url_for('eliminar_registro', id=registro.InventarioID) }}">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="eliminarModalLabel{{ registro.InventarioID }}">Eliminar Registro</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    ¿Estás seguro de que deseas eliminar este registro?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-danger">Eliminar</button>
                </div>
            </div>
        </form>
    </div>
</div>
{% endfor %}

<script>
  document.addEventListener('DOMContentLoaded', function() {
      // Elementos del modal de inventario
      const tipoCombustibleSelect = document.getElementById('tipo-combustible');
      const inventarioInicialInput = document.getElementById('inventario-inicial');
      const entradaInput = document.getElementById('entrada');
      const salidaInput = document.getElementById('salida');
      const inventarioFinalInput = document.getElementById('inventario-final');
  
    function calcularInventarioFinal() {
      // Quitar comas del inventario inicial antes de convertir a número
      const inicial = parseFloat(inventarioInicialInput.value.replace(/,/g, '')) || 0;
      const entrada = parseFloat(entradaInput.value) || 0;
      const salida = parseFloat(salidaInput.value) || 0;
      const final = inicial + entrada - salida;
      // Mostrar con separador de miles
      inventarioFinalInput.value = final.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
    }
  
      // Cuando cambia el tipo de combustible, consulta el inventario inicial
      if (tipoCombustibleSelect) {
          tipoCombustibleSelect.addEventListener('change', function() {
              const tipo = tipoCombustibleSelect.value;
              fetch(`/obtener_inventario_inicial?tipo=${tipo}`)
                  .then(response => response.json())
                  .then(data => {
                      inventarioInicialInput.value = (data.inventario_inicial ? Number(data.inventario_inicial).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '0.00');
                      calcularInventarioFinal();
                  });
          });
      }
  
      // Recalcula inventario final al cambiar entrada o salida
      if (entradaInput) entradaInput.addEventListener('input', calcularInventarioFinal);
      if (salidaInput) salidaInput.addEventListener('input', calcularInventarioFinal);
  
      // Al abrir el modal, dispara el evento para cargar el inventario inicial del tipo por defecto
      const nuevoRegistroModal = document.getElementById('nuevoRegistroModal');
      if (nuevoRegistroModal) {
          nuevoRegistroModal.addEventListener('show.bs.modal', function () {
              const event = new Event('change');
              tipoCombustibleSelect.dispatchEvent(event);
          });
      }
  });
  </script>

<script>
  document.addEventListener('DOMContentLoaded', function() {
      const entradaInput = document.getElementById('entrada');
      const salidaInput = document.getElementById('salida');
  
      function alternarCampos() {
          if (entradaInput.value && parseFloat(entradaInput.value) > 0) {
              salidaInput.value = '';
              salidaInput.disabled = true;
          } else {
              salidaInput.disabled = false;
          }
  
          if (salidaInput.value && parseFloat(salidaInput.value) > 0) {
              entradaInput.value = '';
              entradaInput.disabled = true;
          } else {
              entradaInput.disabled = false;
          }
      }
  
      if (entradaInput && salidaInput) {
          entradaInput.addEventListener('input', alternarCampos);
          salidaInput.addEventListener('input', alternarCampos);
      }
  });
  </script>

<script>
  document.addEventListener('DOMContentLoaded', function() {
      // Obtén el mes y año actual
      const hoy = new Date();
      const mesActual = hoy.getMonth() + 1; // getMonth() es 0-indexado
      const anioActual = hoy.getFullYear();
  
      // Recorre todas las filas de la tabla de inventario
      document.querySelectorAll('tr[data-fecha]').forEach(function(fila) {
          const fechaStr = fila.getAttribute('data-fecha'); // Asegúrate de tener este atributo en cada fila
          if (fechaStr) {
              const fecha = new Date(fechaStr);
              const mesRegistro = fecha.getMonth() + 1;
              const anioRegistro = fecha.getFullYear();
  
              // Si el mes o año es diferente al actual, deshabilita los botones de acción
              if (mesRegistro !== mesActual || anioRegistro !== anioActual) {
                  fila.querySelectorAll('.btn-editar, .btn-eliminar').forEach(function(btn) {
                      btn.disabled = true;
                      btn.classList.add('disabled');
                  });
              }
          }
      });
    });
    </script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
        const hoy = new Date();
        const mesActual = hoy.getMonth() + 1;
        const anioActual = hoy.getFullYear();
    
        document.querySelectorAll('tr[data-fecha]').forEach(function(fila) {
            const fechaStr = fila.getAttribute('data-fecha');
            if (fechaStr) {
                const fecha = new Date(fechaStr);
                const mesRegistro = fecha.getMonth() + 1;
                const anioRegistro = fecha.getFullYear();
    
                if (mesRegistro !== mesActual || anioRegistro !== anioActual) {
                    fila.querySelectorAll('.btn-editar, .btn-eliminar').forEach(function(btn) {
                        // Quitar funcionalidad de modal y enlace
                        btn.removeAttribute('data-bs-toggle');
                        btn.removeAttribute('data-bs-target');
                        btn.removeAttribute('href');
                        btn.classList.add('disabled');
                        btn.style.pointerEvents = 'none';
                        btn.style.opacity = '0.5';
                        btn.title = 'Solo se pueden modificar registros del mes en curso';
                    });
                }
            }
        });
    });
    </script>

<script>
  function updateInventarioInicial(selectElement) {
      const tipo = selectElement.value;
      fetch(`/obtener_inventario_inicial?tipo=${tipo}`)
        .then(response => response.json())
        .then(data => {
          document.querySelector('input[name="inventario_inicial"]').value = (data.inventario_inicial ? Number(data.inventario_inicial).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '0.00');
          // Opcional: recalcula el inventario final si ya hay entrada/salida
          document.querySelector('input[name="inventario_final"]').value = Number(calculateFinalInventory()).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        })
        .catch(error => console.error('Error al obtener el inventario inicial:', error));
  }
  
  function toggleSalida(input) {
      document.getElementById('salida').disabled = input.value !== '';
  document.querySelector('input[name="inventario_final"]').value = Number(calculateFinalInventory()).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
  }
  
  function toggleEntrada(input) {
      document.getElementById('entrada').disabled = input.value !== '';
  document.querySelector('input[name="inventario_final"]').value = Number(calculateFinalInventory()).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
  }
  
  function calculateFinalInventory() {
  const inventarioInicial = parseFloat(document.querySelector('input[name="inventario_inicial"]').value.replace(/,/g, '')) || 0;
      const entrada = parseFloat(document.getElementById('entrada').value) || 0;
      const salida = parseFloat(document.getElementById('salida').value) || 0;
      return inventarioInicial + entrada - salida;
  }
  </script>
<script>
  function cargarPipas() {
      fetch('{{ url_for("listar_pipas_ajax") }}')
          .then(resp => resp.text())
          .then(html => {
              document.getElementById('contenedor-pipas').innerHTML = html;
          });
  }
  </script>

<!-- Eliminado script duplicado de cálculo de inventario final para evitar conflictos y errores -->
{% endblock %}